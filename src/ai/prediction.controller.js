/**
 * prediction.controller.js
 * ─────────────────────────────────────────────────────────────────────
 * Orchestrates all AI services and returns a complete prediction report.
 *
 * POST /api/prediction/analyze
 * Body: { symbol: "AAPL", days?: 10, headlines?: string[] }
 *
 * Response:
 * {
 *   symbol, timestamp, generatedAt,
 *   prices: number[],
 *   trend: { direction, bullishPct, bearishPct, indicators, priceRange, support, resistance },
 *   sentiment: { score, label, breakdown },
 *   risk: { score, level, factors },
 *   confidence: { score, grade, explanation },
 *   aiSummary: string,
 *   disclaimer: string
 * }
 */

import { fetchHistoricalPrices, analyseTrend, generateAISummary } from './prediction.service.js';
import { analyseSentiment }   from './sentiment.service.js';
import { calculateRisk }      from './risk.service.js';
import { calculateConfidence } from './confidence.service.js';

const DISCLAIMER =
  '⚠️ This prediction is generated by an AI model using probabilistic time-series analysis. ' +
  'It is NOT financial advice. Past patterns do not guarantee future performance. ' +
  'Always consult a SEBI-registered financial advisor before making investment decisions.';

export const analyzePrediction = async (req, res) => {
  const { symbol, days = 10, headlines = [] } = req.body;

  if (!symbol || typeof symbol !== 'string') {
    return res.status(400).json({ error: 'symbol is required (e.g. "AAPL")' });
  }

  const cleanSymbol = symbol.trim().toUpperCase();
  const numDays = Math.max(7, Math.min(14, Number(days) || 10));

  try {
    console.log(`[AI Prediction] Running analysis for ${cleanSymbol} over ${numDays} days…`);

    // ── Step 1: Fetch historical prices ─────────────────────────────
    const prices = await fetchHistoricalPrices(cleanSymbol, numDays);

    // ── Step 2: Trend analysis (multi-indicator) ──────────────────
    const trend = analyseTrend(prices);

    // ── Step 3: Sentiment analysis (Gemini + keyword fallback) ────
    const sentiment = await analyseSentiment(cleanSymbol, headlines);

    // ── Step 4: Risk score ────────────────────────────────────────
    const risk = calculateRisk(prices, sentiment.score);

    // ── Step 5: Confidence score ──────────────────────────────────
    const confidence = calculateConfidence(
      prices,
      sentiment.score,
      trend.direction,
      risk.score
    );

    // ── Step 6: Gemini AI narrative summary ───────────────────────
    const aiSummary = await generateAISummary(cleanSymbol, trend, sentiment, risk, confidence);

    // ── Step 7: Build & return full response ──────────────────────
    const payload = {
      symbol:      cleanSymbol,
      generatedAt: new Date().toISOString(),
      daysAnalysed: numDays,
      prices,
      trend,
      sentiment,
      risk,
      confidence,
      aiSummary,
      disclaimer:  DISCLAIMER,
    };

    console.log(`[AI Prediction] ✅ ${cleanSymbol}: ${trend.direction} | Risk ${risk.level} | Conf ${confidence.score}%`);
    return res.status(200).json(payload);

  } catch (err) {
    console.error('[AI Prediction] Error:', err.message);
    return res.status(500).json({ error: 'Prediction analysis failed.', detail: err.message });
  }
};

/**
 * GET /api/prediction/symbols
 * Returns the list of supported symbols.
 */
export const getSupportedSymbols = (req, res) => {
  const symbols = [
    { symbol: 'AAPL',     name: 'Apple Inc.',              exchange: 'NASDAQ' },
    { symbol: 'GOOGL',    name: 'Alphabet Inc.',            exchange: 'NASDAQ' },
    { symbol: 'MSFT',     name: 'Microsoft Corp.',          exchange: 'NASDAQ' },
    { symbol: 'TSLA',     name: 'Tesla Inc.',               exchange: 'NASDAQ' },
    { symbol: 'AMZN',     name: 'Amazon.com Inc.',          exchange: 'NASDAQ' },
    { symbol: 'META',     name: 'Meta Platforms Inc.',      exchange: 'NASDAQ' },
    { symbol: 'NVDA',     name: 'NVIDIA Corp.',             exchange: 'NASDAQ' },
    { symbol: 'RELIANCE', name: 'Reliance Industries Ltd.', exchange: 'NSE'    },
    { symbol: 'TCS',      name: 'Tata Consultancy Services',exchange: 'NSE'    },
    { symbol: 'INFY',     name: 'Infosys Ltd.',             exchange: 'NSE'    },
    { symbol: 'HDFCBANK', name: 'HDFC Bank Ltd.',           exchange: 'NSE'    },
    { symbol: 'SBIN',     name: 'State Bank of India',      exchange: 'NSE'    },
  ];
  return res.status(200).json({ symbols });
};
